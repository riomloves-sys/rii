<!DOCTYPE html>
<html lang="hi" class="">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Application Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- PeerJS for Voice/Video Calls -->
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <style>
        * {
            transition: all 0.3s ease;
        }

        body {
            font-family: 'Inter', sans-serif;
        }

        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }

        .scrollbar-thin::-webkit-scrollbar-track {
            background: transparent;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        :root {
            --bg-primary: #f0f2f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f8fafc;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --border-color: #e2e8f0;
            --message-sent-bg: #3b82f6;
            --message-received-bg: #e2e8f0;
            --icon-color: #64748b;
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        html.dark {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --border-color: #475569;
            --message-sent-bg: #3b82f6;
            --message-received-bg: #334155;
            --icon-color: #cbd5e1;
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        .bg-theme-secondary {
            background-color: var(--bg-secondary);
        }

        .bg-theme-tertiary {
            background-color: var(--bg-tertiary);
        }

        .text-theme-primary {
            color: var(--text-primary);
        }

        .text-theme-secondary {
            color: var(--text-secondary);
        }

        .border-theme {
            border-color: var(--border-color);
        }

        .message-bubble-sent {
            background-color: var(--message-sent-bg);
            color: white;
        }

        .message-bubble-received {
            background-color: var(--message-received-bg);
        }

        .icon-theme {
            color: var(--icon-color);
        }

        .hover\:bg-theme-tertiary:hover {
            background-color: var(--bg-tertiary);
        }

        .message-content img,
        .message-content video,
        .message-content .giphy-gif {
            max-width: 300px;
            border-radius: 1rem;
        }

        .toggle-checkbox:checked {
            right: 0;
            border-color: #3b82f6;
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: #3b82f6;
        }

        .sent-icon {
            color: #888;
        }

        .delivered-icon {
            color: #51a8ff;
        }

        .seen-icon {
            color: #4ade80;
        }

        .fullscreen-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .fullscreen-modal img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 1rem;
        }

        .fullscreen-modal .close-btn {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            cursor: pointer;
            z-index: 101;
            background: rgba(0, 0, 0, 0.5);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
        }

        #giphy-modal {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 90;
        }

        #giphy-content {
            background-color: var(--bg-secondary);
            width: 90%;
            max-width: 600px;
            border-radius: 1.5rem;
            padding: 1.5rem;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        #giphy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.75rem;
            overflow-y: auto;
            margin-top: 1rem;
        }

        #giphy-grid img {
            cursor: pointer;
            border-radius: 0.75rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        #giphy-grid img:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .modern-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .modern-button:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .user-avatar {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .chat-item {
            border-radius: 1rem;
            transition: all 0.2s;
        }

        .chat-item:hover {
            transform: translateX(4px);
        }
    </style>
</head>

<body class="bg-theme-primary">
    <div id="loading-spinner" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="text-center">
            <i class="fas fa-spinner fa-spin text-5xl text-blue-500 mb-4 block"></i>
            <p class="text-gray-600 mt-3 font-medium">Loading...</p>
        </div>
    </div>
    <div id="auth-screen"
        class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100">
        <div class="max-w-md w-full bg-white p-10 rounded-2xl shadow-2xl">
            <div class="text-center mb-8">
                <i class="fas fa-comments text-5xl text-blue-500 mb-3 block"></i>
                <h1 class="text-3xl font-bold text-gray-800">ChatApp Pro</h1>
                <p class="text-gray-500 text-sm mt-1">Modern Messaging Platform</p>
            </div>
            <h2 id="auth-title" class="text-2xl font-bold text-center text-gray-800 mb-8">Welcome Back</h2>
            <form id="auth-form">
                <div class="mb-5">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                    <input id="email" type="email" placeholder="your@email.com"
                        class="w-full px-4 py-3 border border-gray-300 bg-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                        class="w-full px-4 py-3 border border-gray-300 bg-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                </div>
                <button type="submit" id="auth-button"
                    class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition font-semibold shadow-lg hover:shadow-xl">Login</button>
            </form>
            <p id="auth-error" class="text-center text-sm text-red-500 mt-4 hidden"></p>
            <p class="text-center text-sm text-gray-600 mt-6">
                <span id="auth-toggle-text">Don't have an account?</span>
                <a href="#" id="auth-toggle-link" class="text-blue-500 hover:text-blue-700 font-semibold ml-1">Sign
                    Up</a>
            </p>
        </div>
    </div>
    <div id="main-app" class="hidden h-screen w-full md:flex">
        <div id="chat-list-container"
            class="w-full md:w-1/3 lg:w-1/4 bg-theme-secondary border-r border-theme flex flex-col">
            <div class="p-5 border-b border-theme flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Messages</h2>
                    <p class="text-xs text-gray-500 mt-1">Stay connected</p>
                </div>
                <div id="user-profile" class="relative">
                    <img id="user-avatar" src="https://placehold.co/40x40/EFEFEF/AAAAAA&text=U"
                        class="w-11 h-11 rounded-full cursor-pointer user-avatar hover:ring-2 hover:ring-blue-500 ring-offset-2">
                    <div id="user-menu"
                        class="hidden absolute right-0 mt-3 w-52 bg-white rounded-xl shadow-xl py-2 z-20 border border-gray-200">
                        <a href="#" id="theme-toggle-button"
                            class="block px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 flex items-center transition"><i
                                class="fas fa-sun mr-3 text-yellow-500"></i><span>Switch Theme</span></a>
                        <a href="#" id="edit-profile-button"
                            class="block px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 flex items-center transition"><i
                                class="fas fa-user-edit mr-3 text-blue-500"></i>Edit Profile</a>
                        <a href="#" id="show-peer-id-button"
                            class="block px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 flex items-center transition"><i
                                class="fas fa-share-alt mr-3 text-green-500"></i>My Peer ID</a>
                        <a href="#" id="admin-panel-button"
                            class="hidden block px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 flex items-center transition"><i
                                class="fas fa-user-shield mr-3 text-red-500"></i>Admin Panel</a>
                        <hr class="my-2 border-gray-200">
                        <a href="#" id="logout-button"
                            class="block px-4 py-3 text-sm text-red-600 hover:bg-red-50 flex items-center transition"><i
                                class="fas fa-sign-out-alt mr-3"></i>Logout</a>
                    </div>
                </div>
            </div>
            <div class="p-3 border-b border-theme">
                <button id="chat-with-admin-btn"
                    class="w-full bg-gradient-to-r from-green-500 to-emerald-500 text-white py-3 px-4 rounded-lg hover:shadow-lg transition font-semibold flex items-center justify-center gap-2">
                    <i class="fas fa-headset"></i> Chat with Support
                </button>
            </div>
            <input type="text" id="search-input" placeholder="Search conversations..."
                class="mx-3 mt-3 px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-auto"
                style="display: none;">
            <div id="user-list" class="flex-1 overflow-y-auto scrollbar-thin p-2">
            </div>
        </div>
        <div id="chat-window-wrapper" class="flex-1 flex-col bg-theme-primary hidden md:flex">
            <div id="welcome-screen"
                class="flex flex-col items-center justify-center h-full text-center bg-gradient-to-br from-blue-50 to-indigo-50">
                <i class="fas fa-envelope-open text-7xl text-blue-200 mb-6"></i>
                <h2 class="text-3xl font-bold text-gray-800 mb-2">Welcome to ChatApp Pro</h2>
                <p class="text-gray-500 text-lg">Select a conversation to start messaging</p>
            </div>
            <div id="chat-window" class="hidden flex-1 flex flex-col h-full">
                <div class="flex items-center justify-between p-4 border-b border-theme bg-white shadow-sm">
                    <div class="flex items-center flex-1">
                        <button id="back-to-chats-btn"
                            class="md:hidden mr-4 p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg"><i
                                class="fas fa-arrow-left text-xl"></i></button>
                        <img id="chat-header-avatar" src="https://placehold.co/48x48"
                            class="w-12 h-12 rounded-full mr-4 cursor-pointer user-avatar hover:ring-2 hover:ring-blue-500 ring-offset-2">
                        <div>
                            <h3 id="chat-header-name" class="font-bold text-lg text-gray-800"></h3>
                            <div id="chat-header-status-info" class="flex items-center gap-2">
                                <p id="chat-header-status" class="text-xs text-green-500 font-medium"></p>
                                <p id="chat-header-last-seen" class="text-xs text-gray-500"></p>
                            </div>
                            <p id="typing-indicator" class="text-xs text-blue-500 h-4 font-medium italic"></p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button id="voice-call-btn"
                            class="bg-green-500 text-white py-2 px-3 rounded-lg text-xs hover:bg-green-600 transition font-semibold shadow-md hover:shadow-lg"><i
                                class="fas fa-phone mr-1"></i>Voice</button>
                        <button id="video-call-btn"
                            class="bg-blue-500 text-white py-2 px-3 rounded-lg text-xs hover:bg-blue-600 transition font-semibold shadow-md hover:shadow-lg"><i
                                class="fas fa-video mr-1"></i>Video</button>
                        <button id="delete-chat-btn"
                            class="bg-red-500 text-white py-2 px-3 rounded-lg text-xs hover:bg-red-600 transition font-semibold shadow-md hover:shadow-lg"><i
                                class="fas fa-trash-alt"></i></button>
                    </div>
                </div>
                <div id="messages-container"
                    class="flex-1 p-5 overflow-y-auto scrollbar-thin space-y-2 bg-gradient-to-b from-white to-gray-50">
                </div>
                <div class="bg-white p-4 border-t border-theme shadow-lg">
                    <div id="reply-bar"
                        class="hidden flex items-center justify-between p-3 mb-3 bg-blue-50 border-l-4 border-blue-500 rounded-lg">
                        <div class="flex-1">
                            <p class="text-xs text-blue-600 font-semibold">Replying to:</p>
                            <p id="reply-text" class="text-sm text-gray-700 font-medium truncate"></p>
                        </div>
                        <button id="cancel-reply-btn" class="text-gray-400 hover:text-red-500 text-lg transition"><i
                                class="fas fa-times-circle"></i></button>
                    </div>
                    <div id="emoji-sticker-picker"
                        class="hidden grid grid-cols-8 gap-2 p-3 bg-gray-100 rounded-xl mb-3 max-h-[150px] overflow-y-auto scrollbar-thin">
                    </div>
                    <div class="flex items-center gap-3">
                        <button id="emoji-sticker-btn"
                            class="p-2.5 text-yellow-500 hover:bg-yellow-100 rounded-lg transition"><i
                                class="fas fa-smile text-xl"></i></button>
                        <button id="giphy-btn" class="p-2.5 text-pink-500 hover:bg-pink-100 rounded-lg transition"><i
                                class="fas fa-images text-xl"></i></button>
                        <div
                            class="flex-1 flex items-center border-2 border-gray-300 bg-white rounded-full hover:border-blue-500 transition">
                            <input id="message-input" type="text" placeholder="Type your message..."
                                class="flex-1 px-5 py-3 bg-transparent border-none rounded-full focus:outline-none text-gray-800 placeholder-gray-400">
                            <button id="send-btn"
                                class="bg-gradient-to-r from-blue-500 to-blue-600 text-white w-10 h-10 flex-shrink-0 mr-1 rounded-full hover:shadow-lg flex items-center justify-center transition"><i
                                    class="fas fa-paper-plane text-sm"></i></button>
                        </div>
                        <div class="relative flex-shrink-0">
                            <button id="more-options-btn"
                                class="p-2.5 text-gray-500 hover:bg-gray-100 rounded-lg transition"><i
                                    class="fas fa-paperclip text-xl"></i></button>
                            <div id="more-options-menu"
                                class="hidden absolute bottom-full right-0 mb-3 w-max bg-white rounded-lg shadow-xl py-2 z-20 border border-gray-200">
                                <button id="attach-file-btn"
                                    class="w-full flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-gray-100 text-left transition"><i
                                        class="fas fa-file-image w-4 mr-3 text-blue-500"></i>Attach File</button>
                                <button id="record-voice-btn"
                                    class="w-full flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-gray-100 text-left transition"><i
                                        class="fas fa-microphone w-4 mr-3 text-red-500"></i>Record Voice</button>
                            </div>
                        </div>
                        <input type="file" id="file-input" class="hidden" accept="image/*,video/*">
                    </div>
                    <p id="recording-status" class="text-xs text-red-500 mt-2 hidden"><i
                            class="fas fa-circle text-red-500 animate-pulse"></i> Recording...</p>
                </div>
            </div>
        </div>
    </div>
    <div id="edit-profile-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-30 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm">
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h3 class="text-2xl font-bold text-gray-800">Edit Profile</h3>
                <button id="close-edit-profile-modal"
                    class="text-gray-400 hover:text-gray-600 text-3xl transition">&times;</button>
            </div>
            <div class="p-6">
                <div class="flex flex-col items-center mb-6">
                    <img id="profile-avatar-preview" src=""
                        class="w-24 h-24 rounded-full mb-4 border-4 border-blue-500 shadow-lg">
                    <button id="change-avatar-btn"
                        class="text-blue-500 hover:text-blue-700 font-semibold text-sm">Change Photo</button>
                    <input type="file" id="avatar-input" class="hidden" accept="image/*">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Display Name</label>
                    <input type="text" id="display-name-input"
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 transition">
                </div>
                <button id="save-profile-btn"
                    class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition font-semibold shadow-lg hover:shadow-xl">Save
                    Changes</button>
            </div>
        </div>
    </div>
    <div id="fullscreen-image-modal" class="fullscreen-modal hidden" onclick="this.classList.add('hidden');">
        <button class="close-btn" onclick="event.stopPropagation(); this.parentNode.classList.add('hidden');"><i
                class="fas fa-times text-2xl"></i></button>
        <img id="fullscreen-image" src="" alt="Full-screen image" onclick="event.stopPropagation();">
    </div>
    <div id="giphy-modal" class="hidden">
        <div id="giphy-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-800">Search GIFs</h3>
                <button id="close-giphy-modal"
                    class="text-gray-400 hover:text-gray-600 text-3xl transition">&times;</button>
            </div>
            <input type="text" id="giphy-search-input" placeholder="Search for GIFs..."
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 transition">
            <div id="giphy-grid"></div>
        </div>
    </div>
    <div id="call-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-40 p-4">
        <div class="bg-gray-900 rounded-2xl shadow-2xl w-full max-w-2xl">
            <div class="flex justify-between items-center p-6 border-b border-gray-700">
                <div class="flex items-center gap-3">
                    <img id="call-user-avatar" src="" class="w-12 h-12 rounded-full object-cover">
                    <div>
                        <h3 id="call-user-name" class="text-xl font-bold text-white"></h3>
                        <p id="call-status" class="text-sm text-gray-400">Calling...</p>
                    </div>
                </div>
                <button id="close-call-modal"
                    class="text-gray-400 hover:text-white text-3xl transition">&times;</button>
            </div>
            <div class="p-6 bg-gray-800">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="relative bg-black rounded-xl overflow-hidden">
                        <video id="local-video" class="w-full h-64 object-cover bg-black"></video>
                        <p class="absolute bottom-2 left-2 text-white text-xs bg-black bg-opacity-50 px-2 py-1 rounded">
                            You</p>
                    </div>
                    <div class="relative bg-black rounded-xl overflow-hidden">
                        <video id="remote-video" class="w-full h-64 object-cover bg-black"></video>
                        <p class="absolute bottom-2 left-2 text-white text-xs bg-black bg-opacity-50 px-2 py-1 rounded"
                            id="remote-label">Connecting...</p>
                    </div>
                </div>
                <div class="flex justify-center gap-4">
                    <button id="toggle-audio-btn"
                        class="bg-green-500 hover:bg-green-600 text-white py-3 px-6 rounded-full transition shadow-lg">
                        <i class="fas fa-microphone text-xl"></i>
                    </button>
                    <button id="toggle-video-btn"
                        class="bg-blue-500 hover:bg-blue-600 text-white py-3 px-6 rounded-full transition shadow-lg">
                        <i class="fas fa-video text-xl"></i>
                    </button>
                    <button id="end-call-btn"
                        class="bg-red-500 hover:bg-red-600 text-white py-3 px-6 rounded-full transition shadow-lg">
                        <i class="fas fa-phone-slash text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="incoming-call-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-900 rounded-2xl shadow-2xl p-8 w-full max-w-sm text-center">
            <img id="incoming-caller-avatar" src="" class="w-24 h-24 rounded-full object-cover mx-auto mb-4">
            <h3 id="incoming-caller-name" class="text-2xl font-bold text-white mb-2"></h3>
            <p id="incoming-call-type" class="text-gray-400 mb-6">is calling you...</p>
            <div class="flex justify-center gap-4">
                <button id="accept-call-btn"
                    class="bg-green-500 hover:bg-green-600 text-white py-3 px-8 rounded-full font-semibold transition shadow-lg">
                    <i class="fas fa-phone mr-2"></i>Accept
                </button>
                <button id="reject-call-btn"
                    class="bg-red-500 hover:bg-red-600 text-white py-3 px-8 rounded-full font-semibold transition shadow-lg">
                    <i class="fas fa-times mr-2"></i>Reject
                </button>
            </div>
        </div>
    </div>
    <!-- Peer ID Display Modal -->
    <div id="peer-id-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4">
        <div class="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="flex justify-between items-center mb-6">
                <h3
                    class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-green-600">
                    <i class="fas fa-share-alt mr-2 text-blue-500"></i>Your Peer ID
                </h3>
                <button id="close-peer-id-modal"
                    class="text-gray-400 hover:text-gray-600 text-3xl transition duration-200">&times;</button>
            </div>

            <p class="text-gray-600 mb-6 text-base">ðŸ“¤ Share this ID with others so they can call you on your device:
            </p>

            <!-- ID Display Box with better styling -->
            <div
                class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-400 rounded-xl p-5 mb-5 shadow-sm">
                <p class="text-xs text-gray-500 font-semibold mb-2">YOUR ID:</p>
                <code id="peer-id-display"
                    class="text-blue-700 font-mono text-base break-all font-bold tracking-wider">Loading...</code>
            </div>

            <!-- Status indicator -->
            <div class="bg-green-50 border-l-4 border-green-500 rounded p-3 mb-5">
                <p class="text-xs text-gray-600"><i class="fas fa-check-circle text-green-600 mr-2"></i>Ready to receive
                    calls</p>
            </div>

            <div class="flex gap-3">
                <button id="copy-peer-id-btn"
                    class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white py-3 px-4 rounded-lg font-semibold transition shadow-md hover:shadow-lg">
                    <i class="fas fa-copy mr-2"></i><span id="copy-btn-text">Copy to Clipboard</span>
                </button>
                <button id="close-peer-id-btn"
                    class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 px-4 rounded-lg font-semibold transition">
                    <i class="fas fa-times mr-2"></i>Close
                </button>
            </div>

            <p class="text-xs text-gray-500 text-center mt-5">ðŸ’¡ Don't share your ID unless you trust the person</p>
        </div>
    </div>
    <!-- Permission Modal Disabled - Using simple alerts instead -->
    <!--
<div id="permission-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8">
        <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
            <i class="fas fa-lock text-red-500 text-3xl"></i>
            Permission Required
        </h3>
        <p class="text-gray-700 mb-6">
            To use voice/video calls, you need to grant camera and microphone permissions.
        </p>
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded">
            <p class="font-semibold text-gray-800 mb-3">How to allow permissions:</p>
            <ol class="text-sm text-gray-700 space-y-2 list-decimal list-inside">
                <li>A permission popup will appear</li>
                <li>Click <strong>"Allow"</strong> to grant access</li>
                <li>If blocked, check your browser settings</li>
            </ol>
        </div>
        <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-6 rounded">
            <p class="font-semibold text-gray-800 mb-2">Browser Instructions:</p>
            <p class="text-sm text-gray-700">
                <strong>Chrome:</strong> Settings â†’ Privacy â†’ Camera/Microphone<br>
                <strong>Firefox:</strong> Options â†’ Privacy â†’ Permissions<br>
                <strong>Safari:</strong> Preferences â†’ Websites â†’ Camera/Microphone
            </p>
        </div>
        <button id="retry-permission-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-semibold transition">
            <i class="fas fa-redo mr-2"></i>Retry
        </button>
    </div>
</div>
-->
    <div id="admin-panel" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-30 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h3 class="text-2xl font-bold text-gray-800"><i class="fas fa-user-shield mr-3 text-red-500"></i>Admin
                    Panel</h3>
                <button id="close-admin-panel"
                    class="text-gray-400 hover:text-gray-600 text-3xl transition">&times;</button>
            </div>
            <div class="flex-1 flex overflow-hidden">
                <div class="w-1/4 border-r border-gray-200 p-4 bg-gray-50">
                    <nav class="flex flex-col space-y-2">
                        <a href="#users"
                            class="admin-tab-link bg-blue-500 text-white font-semibold flex items-center px-4 py-3 rounded-lg transition"><i
                                class="fas fa-users mr-3"></i>Users</a>
                        <a href="#content"
                            class="admin-tab-link text-gray-700 hover:bg-gray-200 flex items-center px-4 py-3 rounded-lg transition"><i
                                class="fas fa-photo-video mr-3"></i>Content</a>
                        <a href="#registrations"
                            class="admin-tab-link text-gray-700 hover:bg-gray-200 flex items-center px-4 py-3 rounded-lg transition"><i
                                class="fas fa-user-plus mr-3"></i>Registrations</a>
                    </nav>
                </div>
                <div class="w-3/4 p-6 overflow-y-auto">
                    <div id="admin-tab-users" class="admin-tab-content">
                        <h4 class="text-xl font-bold mb-4 text-gray-800">Manage Users</h4>
                        <div id="admin-user-list" class="space-y-3">
                        </div>
                    </div>
                    <div id="admin-tab-content" class="admin-tab-content hidden">
                        <h4 class="text-xl font-bold mb-4 text-gray-800">Stickers & Emojis</h4>
                        <div class="p-6 bg-blue-50 rounded-xl">
                            <h5 class="font-bold text-lg mb-3 text-gray-800">Add New Sticker/Emoji</h5>
                            <div class="flex items-center space-x-3 mb-6">
                                <input type="text" id="new-sticker-url" placeholder="Paste URL or Emoji"
                                    class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 transition">
                                <button id="add-sticker-btn"
                                    class="bg-blue-500 text-white py-3 px-6 rounded-lg hover:bg-blue-600 font-semibold shadow-md hover:shadow-lg transition">Add</button>
                            </div>
                            <h5 class="font-bold text-lg mb-3 text-gray-800">Current Stickers & Emojis</h5>
                            <div id="sticker-list-container" class="grid grid-cols-8 gap-3">
                            </div>
                        </div>
                    </div>
                    <div id="admin-tab-registrations" class="admin-tab-content hidden">
                        <h4 class="text-xl font-bold mb-4 text-gray-800">Registrations</h4>
                        <div class="space-y-4 p-6 bg-green-50 rounded-xl">
                            <div class="flex items-center justify-between">
                                <div>
                                    <label class="font-bold text-lg text-gray-800">Allow New Registrations</label>
                                    <p class="text-sm text-gray-600 mt-1">Allow new users to sign up.</p>
                                </div>
                                <div class="flex items-center">
                                    <span id="registration-status-text"
                                        class="text-sm font-bold mr-4 text-blue-600">ON</span>
                                    <div class="relative inline-block w-14 align-middle select-none">
                                        <input type="checkbox" name="registration-toggle" id="registration-toggle"
                                            class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" />
                                        <label for="registration-toggle"
                                            class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyD86N7zF7rm_0_E_PuoSdD6cwQTGmIlL7s",
            authDomain: "dekha-5daeb.firebaseapp.com",
            databaseURL: "https://dekha-5daeb-default-rtdb.firebaseio.com",
            projectId: "dekha-5daeb",
            storageBucket: "dekha-5daeb.firebasestorage.app",
            messagingSenderId: "647841969799",
            appId: "1:647841969799:web:c133fdc1cc8ea986846a22"
        };
        const cloudinaryConfig = { cloud_name: "dl4rnmjyn", upload_preset: "chatting" };
        const ADMIN_EMAIL = "admin@example.com";
        const GIPHY_API_KEY = "UmalJbfKMvbuarXuOCztHglcJFQZrNSr";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, addDoc, serverTimestamp, orderBy, getDocs, writeBatch, updateDoc, deleteDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getDatabase, ref, onValue, set, onDisconnect, remove, off } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);
        // Global State
        let currentUser = null;
        let isAdmin = false;
        let currentChatUser = null;
        let currentChatId = null;
        let unsubscribeMessages = null;
        let typingTimeout = null;
        let typingListenerRef = null;

        // Function to update state variables
        function setChatState(key, value) {
            if (key === 'currentUser') currentUser = value;
            if (key === 'isAdmin') isAdmin = value;
            if (key === 'currentChatUser') currentChatUser = value;
            if (key === 'currentChatId') currentChatId = value;
            if (key === 'unsubscribeMessages') unsubscribeMessages = value;
            if (key === 'typingTimeout') typingTimeout = value;
            if (key === 'typingListenerRef') typingListenerRef = value;
        }

        // Presence and Status
        function setupPresence() {
            if (!currentUser) return;
            const userStatusDatabaseRef = ref(rtdb, '/status/' + currentUser.uid);
            const userStatusFirestoreRef = doc(db, 'users', currentUser.uid);
            const isOfflineForRTDB = { state: 'offline' };
            const isOnlineForRTDB = { state: 'online' };
            const isOfflineForFirestore = { isOnline: false, lastSeen: serverTimestamp() };
            const isOnlineForFirestore = { isOnline: true };
            const connectedRef = ref(rtdb, '.info/connected');
            onValue(connectedRef, (snap) => {
                if (snap.val() === true) {
                    set(userStatusDatabaseRef, isOnlineForRTDB);
                    updateDoc(userStatusFirestoreRef, isOnlineForFirestore);
                    onDisconnect(userStatusDatabaseRef).set(isOfflineForRTDB).then(() => {
                        updateDoc(userStatusFirestoreRef, isOfflineForFirestore);
                    });
                }
            });
        }
        let siteSettings = {};
        function listenToSiteSettings() {
            const settingsDocRef = doc(db, "siteSettings", "config");
            onSnapshot(settingsDocRef, (docSnap) => {
                siteSettings = docSnap.exists() ? docSnap.data() : { registrationsEnabled: true, stickers: [] };
                if (isAdmin) {
                    document.getElementById('registration-toggle').checked = siteSettings.registrationsEnabled;
                }
                const authToggleText = document.getElementById('auth-toggle-text');
                const authToggleLink = document.getElementById('auth-toggle-link');
                if (!siteSettings.registrationsEnabled) {
                    authToggleText.classList.add('hidden');
                    authToggleLink.classList.add('hidden');
                } else {
                    authToggleText.classList.remove('hidden');
                    authToggleLink.classList.remove('hidden');
                }
            });
        }
        async function loadUserList() {
            const userListEl = document.getElementById('user-list');
            const q = query(collection(db, "users"));
            onSnapshot(q, (snapshot) => {
                userListEl.innerHTML = '';
                snapshot.forEach(doc => {
                    const user = doc.data();
                    if (user.uid === currentUser.uid) return;
                    const userEl = document.createElement('div');
                    userEl.className = 'chat-item flex items-center gap-3 p-3 hover:bg-blue-100 cursor-pointer rounded-xl mb-2 border border-transparent hover:border-blue-400 transition-all duration-200';
                    userEl.dataset.uid = user.uid;
                    userEl.innerHTML = `
                <div class="relative flex-shrink-0">
                    <img src="${user.photoURL}" class="w-12 h-12 rounded-full object-cover shadow-md">
                    ${user.isOnline ? '<span class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full shadow-lg"></span>' : '<span class="absolute bottom-0 right-0 w-3 h-3 bg-gray-400 border-2 border-white rounded-full"></span>'}
                </div>
                <div class="flex-1 min-w-0">
                    <h4 class="font-bold text-gray-800 text-sm truncate">${user.displayName || 'User'}</h4>
                    <p class="text-xs text-gray-500 mt-0.5">${user.isAdmin ? 'Admin' : 'User'}</p>
                </div>
                <div class="flex-shrink-0 text-right flex flex-col items-end gap-1">
                    <p class="text-xs font-semibold ${user.isOnline ? 'text-green-600' : 'text-gray-500'}">${user.isOnline ? 'Online' : 'Offline'}</p>
                    ${user.isOnline ? `<button class="quick-video-call-btn p-1.5 bg-blue-100 text-blue-600 rounded-full hover:bg-blue-200 transition shadow-sm" title="Start Video Call"><i class="fas fa-video text-xs"></i></button>` : ''}
                </div>
            `;
                    userEl.addEventListener('click', () => startChat(user));

                    // Add click listener for the video button if it exists
                    const videoBtn = userEl.querySelector('.quick-video-call-btn');
                    if (videoBtn) {
                        videoBtn.addEventListener('click', (e) => {
                            e.stopPropagation(); // Prevent default chat opening
                            startChat(user);
                            // Wait a moment for the view to switch then start call
                            setTimeout(() => initiateCall('video'), 500);
                        });
                    }

                    userListEl.appendChild(userEl);
                });
            });
        }
        async function startChat(otherUser) {
            setChatState('currentChatUser', otherUser);
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('chat-window').classList.remove('hidden');
            if (window.innerWidth < 768) {
                document.getElementById('chat-list-container').classList.add('hidden');
                document.getElementById('chat-window-wrapper').classList.remove('hidden');
            }
            document.getElementById('chat-header-avatar').src = otherUser.photoURL;
            document.getElementById('chat-header-name').textContent = otherUser.displayName;

            const userStatusRef = ref(rtdb, '/status/' + otherUser.uid);
            // last seen feature
            const userFirestoreRef = doc(db, 'users', otherUser.uid);
            const statusEl = document.getElementById('chat-header-status');
            const lastSeenEl = document.getElementById('chat-header-last-seen');

            onSnapshot(userFirestoreRef, (docSnap) => {
                const userData = docSnap.data();
                if (userData && userData.isOnline) {
                    statusEl.textContent = 'Online';
                    statusEl.className = 'text-sm text-green-500';
                    lastSeenEl.textContent = '';
                } else {
                    if (userData && userData.lastSeen) {
                        const lastSeenTime = new Date(userData.lastSeen.toDate()).toLocaleString();
                        lastSeenEl.textContent = `Last seen: ${lastSeenTime}`;
                    } else {
                        lastSeenEl.textContent = 'Last seen: N/A';
                    }
                    statusEl.textContent = 'Offline';
                    statusEl.className = 'text-sm text-gray-400';
                }
            });

            const uids = [currentUser.uid, otherUser.uid].sort();
            setChatState('currentChatId', uids.join('_'));
            const messagesRef = collection(db, 'chats', currentChatId, 'messages');
            const q = query(messagesRef);
            const querySnapshot = await getDocs(q);
            const batch = writeBatch(db);
            querySnapshot.forEach(docSnap => {
                const msg = docSnap.data();
                if (msg.senderUid !== currentUser.uid && !msg.seenAt) {
                    batch.update(doc(messagesRef, docSnap.id), { seenAt: serverTimestamp() });
                }
            });
            await batch.commit();
            loadMessages();
            const typingIndicatorEl = document.getElementById('typing-indicator');
            if (typingListenerRef) {
                off(typingListenerRef);
            }
            setChatState('typingListenerRef', ref(rtdb, `typing/${currentChatId}/${currentChatUser.uid}`));
            onValue(typingListenerRef, (snapshot) => {
                if (snapshot.exists() && snapshot.val() === true) {
                    typingIndicatorEl.textContent = 'typing...';
                    lastSeenEl.classList.add('hidden');
                    statusEl.classList.add('hidden');
                } else {
                    typingIndicatorEl.textContent = '';
                    lastSeenEl.classList.remove('hidden');
                    statusEl.classList.remove('hidden');
                }
            });

            // Listen for incoming calls
            const callRef = doc(db, 'calls', currentChatId);
            onSnapshot(callRef, (docSnap) => {
                if (docSnap.exists()) {
                    const callData = docSnap.data();
                    if (callData.status === 'ringing' && callData.from !== currentUser.uid && !isCallActive) {
                        receiveCallNotification(callData);
                    }
                }
            });
        }
        // Messages and media
        function loadMessages() {
            if (unsubscribeMessages) unsubscribeMessages();
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = '';
            const messagesRef = collection(db, 'chats', currentChatId, 'messages');
            const q = query(messagesRef, orderBy('timestamp'));
            setChatState('unsubscribeMessages', onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const msg = change.doc.data();
                    if (change.type === "added") {
                        const tempMsg = messagesContainer.querySelector(`[data-temp-content="${msg.content}"]`);
                        if (tempMsg) {
                            tempMsg.dataset.id = change.doc.id;
                            tempMsg.dataset.tempContent = '';
                            updateMessageStatus(tempMsg, msg);
                        } else {
                            displayMessage(msg, change.doc.id);
                        }
                    }
                    if (change.type === "modified") {
                        const existingMsg = messagesContainer.querySelector(`[data-id="${change.doc.id}"]`);
                        if (existingMsg) {
                            updateMessageStatus(existingMsg, msg);
                        }
                    }
                });
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }));
        }
        async function displayMessage(msg, docId) {
            const messagesContainer = document.getElementById('messages-container');
            const isSent = msg.senderUid === currentUser.uid;
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex mb-3 ${isSent ? 'justify-end' : 'justify-start'}`;
            messageWrapper.dataset.id = docId;
            if (!docId) messageWrapper.dataset.tempContent = msg.content;
            let contentHtml = '';
            if (msg.replyToId) {
                const originalMsgRef = doc(db, 'chats', currentChatId, 'messages', msg.replyToId);
                const originalMsgSnap = await getDoc(originalMsgRef);
                const originalMsgContent = originalMsgSnap.exists() ? (originalMsgSnap.data().content || "File/Media") : "Original message not found";
                const replyHtml = `<div class="p-3 border-l-4 border-blue-500 mb-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
            <p class="text-xs text-blue-600 font-semibold">Replying to:</p>
            <p class="text-sm text-gray-700 truncate">${originalMsgContent}</p>
        </div>`;
                contentHtml += replyHtml;
            }
            switch (msg.type) {
                case 'text': contentHtml += `<p class="whitespace-pre-wrap break-words">${msg.content}</p>`; break;
                case 'image': contentHtml += `<img src="${msg.url}" class="rounded-lg shadow-md cursor-pointer hover:shadow-lg transition" onclick="window.open('${msg.url}', '_blank')">`; break;
                case 'video': contentHtml += `<video controls src="${msg.url}" class="rounded-lg shadow-md max-w-xs"></video>`; break;
                case 'audio': contentHtml += `<audio controls src="${msg.url}" class="rounded-lg"></audio>`; break;
                case 'sticker': contentHtml += `<img src="${msg.url}" class="w-24 h-24 object-contain hover:scale-110 transition">`; break;
                case 'gif': contentHtml += `<img src="${msg.url}" class="rounded-lg shadow-md giphy-gif hover:shadow-lg transition">`; break;
            }
            const timestamp = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : 'Sending...';
            const statusIcon = getMessageStatusIcon(msg, isSent);
            messageWrapper.innerHTML = `
        <div class="max-w-xs lg:max-w-md">
            <div class="${isSent ? 'message-bubble-sent' : 'message-bubble-received'} p-4 rounded-2xl shadow-md ${isSent ? 'rounded-br-none' : 'rounded-bl-none'}">
                <div class="message-content text-sm">${contentHtml}</div>
            </div>
            <p class="text-xs text-gray-500 mt-1 px-2 ${isSent ? 'text-right' : 'text-left'}">${timestamp} ${statusIcon}</p>
        </div>
    `;
            messagesContainer.appendChild(messageWrapper);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        function getMessageStatusIcon(msg, isSent) {
            if (!isSent) return '';
            if (msg.seenAt) {
                return `<i class="fas fa-check-double delivered-icon seen-icon ml-1"></i>`;
            } else if (msg.timestamp) {
                return `<i class="fas fa-check-double delivered-icon ml-1"></i>`;
            } else {
                return `<i class="fas fa-spinner fa-spin text-theme-secondary ml-1"></i>`;
            }
        }
        function updateMessageStatus(messageEl, msg) {
            const timestampEl = messageEl.querySelector('.text-xs');
            const newTimestamp = new Date(msg.timestamp.toDate()).toLocaleString();
            const newIcon = getMessageStatusIcon(msg, true);
            timestampEl.innerHTML = `${newTimestamp} ${newIcon}`;
        }
        async function sendMessage(type, content, url = null, replyToId = null) {
            if (!currentChatId || (!content && !url)) return;
            const messagesRef = collection(db, 'chats', currentChatId, 'messages');
            const tempMessage = {
                type, content, url, senderUid: currentUser.uid, timestamp: null, replyToId
            };
            displayMessage(tempMessage, null);
            await addDoc(messagesRef, { type, content, url, senderUid: currentUser.uid, timestamp: serverTimestamp(), replyToId });
        }
        async function uploadFile(file) {
            if (!file) return;
            document.getElementById('loading-spinner').classList.remove('hidden');
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', cloudinaryConfig.upload_preset);
            try {
                const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloud_name}/${file.type.startsWith('image/') ? 'image' : 'video'}/upload`, {
                    method: 'POST',
                    body: formData,
                });
                const data = await response.json();
                const type = file.type.startsWith('image/') ? 'image' : 'video';
                sendMessage(type, file.name, data.secure_url);
            } catch (error) {
                console.error("File upload failed:", error);
                alert("Failed to upload file.");
            } finally {
                document.getElementById('loading-spinner').classList.add('hidden');
            }
        }
        async function uploadAudio(audioBlob) {
            if (!audioBlob) return;
            document.getElementById('loading-spinner').classList.remove('hidden');
            const formData = new FormData();
            formData.append('file', audioBlob);
            formData.append('upload_preset', cloudinaryConfig.upload_preset);
            try {
                const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloud_name}/raw/upload`, {
                    method: 'POST',
                    body: formData,
                });
                const data = await response.json();
                sendMessage('audio', 'Voice Message', data.secure_url);
            } catch (error) {
                console.error("Audio upload failed:", error);
                alert("Failed to upload voice message.");
            } finally {
                document.getElementById('loading-spinner').classList.add('hidden');
            }
        }
        async function updateUserData(uid, data) {
            const userDocRef = doc(db, "users", uid);
            return updateDoc(userDocRef, data);
        }
        function initEmojiStickerPicker() {
            const picker = document.getElementById('emoji-sticker-picker');
            onSnapshot(doc(db, "siteSettings", "config"), (docSnap) => {
                const stickers = docSnap.exists() ? docSnap.data().stickers || [] : [];
                picker.innerHTML = '';
                const defaultEmojis = ['ðŸ˜­', 'ðŸ¥²', 'ðŸ˜‹', 'ðŸ¤¡', 'ðŸ‘½', 'ðŸ‘º', 'ðŸ‘¹', 'ðŸ’€', 'ðŸ‘¿', 'ðŸ˜ˆ', 'â˜ ï¸', 'ðŸ¥°', 'ðŸ˜²', 'â˜¹ï¸', 'ðŸ˜', 'ðŸ–•', 'ðŸ˜˜', 'ðŸ˜‚', 'ðŸ™‚', 'ðŸ˜“', 'ðŸ˜”', 'ðŸ˜š', 'ðŸ¥º', 'ðŸ˜³', 'ðŸ¤¨', 'ðŸ§', 'ðŸ¤£', 'ðŸ˜‚', 'ðŸ˜', 'ðŸ˜€', 'ðŸ˜ƒ', 'ðŸ˜‰', 'ðŸ˜—', 'ðŸ˜™', 'ðŸ¥³', 'ðŸ« ', 'ðŸ™ƒ', 'ðŸ¥¹', 'ðŸ¤¤', 'ðŸ˜', 'ðŸ˜', 'ðŸ˜‘', 'ðŸ¤«', 'ðŸ¤”', 'ðŸ«¡', 'ðŸ˜±', 'ðŸ™„', 'ðŸ§', 'ðŸ«¤', 'ðŸ˜²', 'ðŸ¤¯', 'ðŸ˜°', 'ðŸ˜•', 'ðŸ˜–', 'ðŸ˜«', 'ðŸ˜©', 'ðŸ˜£', 'ðŸ˜µ', 'ðŸ˜µâ€ðŸ’«', 'ðŸ«¨', 'ðŸ¤¢', 'ðŸ¤•', 'ðŸ˜·', 'ðŸ˜‡', 'ðŸ˜Ž', 'ðŸ¤“', 'ðŸŒ', 'ðŸŒš', 'ðŸ˜º', 'ðŸ˜¸', 'ðŸ˜¹', 'ðŸ˜»', 'ðŸ˜¼', 'ðŸ˜½', 'ðŸ™€', 'ðŸ˜¿', 'ðŸ˜¿', 'ðŸ˜¾', 'ðŸŒœ', 'ðŸŒ›', 'ðŸ™Š', 'ðŸ™‰', 'ðŸ™ˆ', 'ðŸ”¥', 'â¤ï¸', 'ðŸ’˜', 'ðŸ’', 'ðŸ©·', 'ðŸ’—', 'ðŸ’–', 'ðŸ’”', 'â¤ï¸â€ðŸ©¹', 'â¤ï¸â€ðŸ”¥', 'ðŸ’‹', 'â™¥ï¸', 'ðŸ’Ÿ', 'ðŸ’•', 'ðŸ«‚', 'ðŸ«€', 'ðŸ«¦', 'ðŸ‘„', 'ðŸ‘ï¸', 'ðŸ‘€', 'ðŸ’ª', 'ðŸ¤œ', 'ðŸ¤›', 'ðŸ‘Ž', 'ðŸ«¶', 'ðŸ«´', 'ðŸ‘', 'ðŸ‘‹', 'ðŸ‘Š', 'ðŸ‘Œ', 'ðŸ«µ', 'âœŒï¸', 'ðŸ¤˜', 'ðŸ¤Ÿ', 'ðŸ¤', 'ðŸ‘‡', 'ðŸ‘†', 'â˜ï¸', 'ðŸ‘ˆ', 'ðŸ™', 'ðŸ¤', 'ðŸ–•', 'ðŸ¤¦', 'ðŸ¤¦ðŸ¼â€â™€ï¸', 'ðŸ’†ðŸ¼â€â™€ï¸', 'ðŸ™ŽðŸ¼â€â™€ï¸', 'ðŸ™ðŸ¼â€â™€ï¸', 'ðŸ™‡ðŸ¼â€â™€ï¸', 'ðŸ§–ðŸ¼â€â™€ï¸', 'ðŸ›€ðŸ¼', 'ðŸ‘¸ðŸ¼', 'ðŸ•ºðŸ¼', 'ðŸ’‘', 'ðŸ‘©â€â¤ï¸â€ðŸ’‹â€ðŸ‘©', 'ðŸ‘¨â€â¤ï¸â€ðŸ’‹â€ðŸ‘¨', 'ðŸ‘©â€â¤ï¸â€ðŸ‘©', 'ðŸ‘©ðŸ¼â€ðŸ¼', 'ðŸ¤°ðŸ¼', 'ðŸ’', 'ðŸŒº', 'ðŸ¥€', 'ðŸŒ¹', 'ðŸŒ¸', 'ðŸµï¸', 'ðŸƒ', 'ðŸ‚', 'ðŸŒ±', 'ðŸŒ¼', 'ðŸŒ±', 'ðŸŒµ', 'ðŸ€', 'ðŸŒ¾', 'ðŸ„', 'â„ï¸', 'â›„', 'ðŸŒš', 'ðŸŒ', 'ðŸŒž', 'ðŸ¼', 'ðŸ¦', 'ðŸ¯', 'ðŸ±', 'ðŸ¸', 'ðŸ‰', 'ðŸ¦•', 'ðŸ¦–', 'ðŸ©', 'ðŸ¦Ž', 'ðŸ•', 'ðŸˆ', 'ðŸ•â€ðŸ¦º', 'ðŸˆâ€â¬›', 'ðŸ¦®', 'ðŸ²', 'ðŸƒ', 'ðŸ„', 'ðŸ‘', 'ðŸ‚', 'ðŸ¦¬', 'ðŸ¦£', 'ðŸ¦¥', 'ðŸ˜', 'ðŸ¦›', 'ðŸ¦§', 'ðŸ’', 'ðŸ¿ï¸', 'ðŸ†', 'ðŸ¦', 'ðŸª¼', 'ðŸ¦‘', 'ðŸ¦â€ðŸ”¥', 'ðŸ¦¢', 'ðŸª¿', 'ðŸ¥', 'ðŸ¦ƒ', 'ðŸª²', 'ðŸš', 'ðŸ›', 'ðŸª¼', 'ðŸ¦ ', 'ðŸž', 'ðŸ›', 'ðŸª³', 'ðŸŒ¶ï¸', 'ðŸ’', 'ðŸŠ', 'ðŸ…', 'ðŸ', 'ðŸŠ', 'ðŸ¥‘', 'ðŸ', 'ðŸ¥’', 'ðŸ«œ', 'ðŸž', 'ðŸ«’', 'ðŸ¥œ', 'ðŸŸ', 'ðŸŒ­', 'ðŸ—', 'ðŸŸ', 'ðŸ§€', 'ðŸ¥', 'ðŸ¥–', 'ðŸ«•', 'ðŸ§†', 'ðŸ£', 'ðŸ¥«', 'ðŸ¥¨', 'ðŸ•', 'ðŸ˜', 'ðŸ¥¡', 'ðŸ˜', 'ðŸ¦', 'ðŸ¢', 'ðŸœ', 'ðŸ¦ž', 'ðŸ£', 'ðŸ¥¡', 'ðŸš', 'ðŸ±', 'ðŸ±', 'ðŸ¥®', 'ðŸ¥ ', 'ðŸ¡', 'ðŸ¥', 'ðŸ˜', 'ðŸ¢', 'ðŸ¨', 'ðŸ¨', 'ðŸ¥§', 'ðŸ®', 'ðŸ§', 'ðŸ­', 'ðŸ¬', 'ðŸ«™', 'ðŸ¿', 'ðŸ§ˆ', 'ðŸ«', 'ðŸ’', 'ðŸ‘‘'];
                defaultEmojis.forEach(emoji => {
                    const btn = document.createElement('button');
                    btn.className = 'p-1 rounded-full hover:bg-blue-200 text-2xl';
                    btn.textContent = emoji;
                    btn.addEventListener('click', () => {
                        document.getElementById('message-input').value += btn.textContent;
                        document.getElementById('message-input').focus();
                    });
                    picker.appendChild(btn);
                });
                stickers.forEach(sticker => {
                    const img = document.createElement('img');
                    img.src = sticker.url;
                    img.className = 'w-12 h-12 object-contain cursor-pointer';
                    img.addEventListener('click', () => {
                        sendMessage('sticker', 'sticker', sticker.url);
                        document.getElementById('emoji-sticker-picker').classList.add('hidden');
                    });
                    picker.appendChild(img);
                });
            });
        }
        // Global UI elements
        const loadingSpinner = document.getElementById('loading-spinner');
        const authScreen = document.getElementById('auth-screen');
        const mainApp = document.getElementById('main-app');
        const chatListContainer = document.getElementById('chat-list-container');
        const chatWindowWrapper = document.getElementById('chat-window-wrapper');
        const backToChatsBtn = document.getElementById('back-to-chats-btn');
        const welcomeScreen = document.getElementById('welcome-screen');
        const themeToggleButton = document.getElementById('theme-toggle-button');
        const authForm = document.getElementById('auth-form');
        const authToggleLink = document.getElementById('auth-toggle-link');
        const authError = document.getElementById('auth-error');
        const authToggleText = document.getElementById('auth-toggle-text');
        const adminPanelButton = document.getElementById('admin-panel-button');
        const adminPanel = document.getElementById('admin-panel');
        const closeAdminPanel = document.getElementById('close-admin-panel');
        const giphyBtn = document.getElementById('giphy-btn');
        const giphyModal = document.getElementById('giphy-modal');
        const closeGiphyModal = document.getElementById('close-giphy-modal');
        const giphySearchInput = document.getElementById('giphy-search-input');
        const giphyGrid = document.getElementById('giphy-grid');
        const editProfileModal = document.getElementById('edit-profile-modal');
        const editProfileButton = document.getElementById('edit-profile-button');
        const closeEditProfileModal = document.getElementById('close-edit-profile-modal');
        const profileAvatarPreview = document.getElementById('profile-avatar-preview');
        const changeAvatarBtn = document.getElementById('change-avatar-btn');
        const avatarInput = document.getElementById('avatar-input');
        const displayNameInput = document.getElementById('display-name-input');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const replyBar = document.getElementById('reply-bar');
        const replyText = document.getElementById('reply-text');
        const cancelReplyBtn = document.getElementById('cancel-reply-btn');
        const chatHeaderAvatar = document.getElementById('chat-header-avatar');
        const deleteChatBtn = document.getElementById('delete-chat-btn');
        const fullscreenImageModal = document.getElementById('fullscreen-image-modal');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const recordVoiceBtn = document.getElementById('record-voice-btn');
        const recordingStatus = document.getElementById('recording-status');
        const voiceCallBtn = document.getElementById('voice-call-btn');
        const videoCallBtn = document.getElementById('video-call-btn');
        const callModal = document.getElementById('call-modal');
        const incomingCallModal = document.getElementById('incoming-call-modal');
        const closeCallModal = document.getElementById('close-call-modal');
        const endCallBtn = document.getElementById('end-call-btn');
        const acceptCallBtn = document.getElementById('accept-call-btn');
        const rejectCallBtn = document.getElementById('reject-call-btn');
        const toggleAudioBtn = document.getElementById('toggle-audio-btn');
        const toggleVideoBtn = document.getElementById('toggle-video-btn');
        const localVideo = document.getElementById('local-video');
        const remoteVideo = document.getElementById('remote-video');
        const permissionModal = document.getElementById('permission-modal');
        // const retryPermissionBtn = document.getElementById('retry-permission-btn'); // Disabled - using simple alerts instead
        const peerIdModal = document.getElementById('peer-id-modal');
        const peerIdDisplay = document.getElementById('peer-id-display');
        const closePeerIdModal = document.getElementById('close-peer-id-modal');
        const closePeerIdBtn = document.getElementById('close-peer-id-btn');
        const copyPeerIdBtn = document.getElementById('copy-peer-id-btn');
        const showPeerIdBtn = document.getElementById('show-peer-id-button');
        let isLogin = true;
        let replyToMessageId = null;
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let gifSearchTimeout = null;

        // Call Variables
        let peerConnection = null;
        let localStream = null;
        let isCallActive = false;
        let isAudioEnabled = true;
        let isVideoEnabled = true;
        let callType = 'audio'; // 'audio' or 'video'
        let pendingCallType = null;

        // Check if running on HTTPS or localhost
        function isSecureContext() {
            return location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
        }

        // Check permission status
        async function checkPermissionStatus(mediaType) {
            try {
                if (!navigator.permissions || !navigator.permissions.query) {
                    console.log('âš ï¸ Permissions API not available');
                    return 'unknown';
                }
                const result = await navigator.permissions.query({ name: mediaType });
                console.log(`ðŸ” ${mediaType} permission status:`, result.state);
                return result.state; // 'granted', 'denied', 'prompt'
            } catch (error) {
                console.warn('Cannot check permission:', error);
                return 'unknown';
            }
        }

        // Permission Modal Disabled - Using simple alerts instead
        /*
        function showPermissionError() {
            callModal.classList.add('hidden');
            permissionModal.classList.remove('hidden');
        }
        
        function hidePermissionError() {
            permissionModal.classList.add('hidden');
        }
        */

        function hidePermissionError() {
            // Disabled
        }

        // Helper Functions
        function showAuthScreen() {
            authScreen.classList.remove('hidden');
            mainApp.classList.add('hidden');
            loadingSpinner.classList.add('hidden');
        }
        function showMainApp() {
            authScreen.classList.add('hidden');
            mainApp.classList.remove('hidden');
            mainApp.classList.add('flex');
            loadingSpinner.classList.add('hidden');
            chatListContainer.classList.remove('hidden');
            chatWindowWrapper.classList.add('hidden');
        }

        // ==================== PeerJS CALL SYSTEM ====================
        // Initialize PeerJS
        let peer = null;
        let currentCall = null;
        let currentUserPeerId = null;

        function generateFallbackPeerId() {
            // Generate a unique ID if PeerJS fails
            const uid = currentUser.uid.substring(0, 8);
            const random = Math.random().toString(36).substring(2, 8);
            return `user_${uid}_${random}`;
        }

        function initializePeer() {
            if (peer || currentUserPeerId) return; // Already initialized

            if (!currentUser || !currentUser.uid) {
                console.warn('âš ï¸ User not logged in yet, skipping PeerJS initialization');
                return;
            }

            const peerId = 'user_' + currentUser.uid.substring(0, 10);

            try {
                // Check if Peer class exists
                if (typeof Peer === 'undefined') {
                    throw new Error('PeerJS library not loaded');
                }

                // Use PeerJS cloud server (default) or custom config
                const peerConfig = {
                    debug: 1, // More debug info to diagnose issues
                    // Don't set iceServers - let PeerJS use defaults
                    // The custom iceServers config was causing issues
                };

                console.log('ðŸ”Œ Initializing PeerJS with ID:', peerId);
                peer = new Peer(peerId, peerConfig);

                // Safety check - verify peer was created
                if (!peer) {
                    throw new Error('Peer object creation failed');
                }

                console.log('ðŸ“¡ Peer object created, waiting for connection...');

                // Only attach listeners if peer is valid
                if (typeof peer.on === 'function') {
                    peer.on('open', function (id) {
                        console.log('âœ… PeerJS Ready. Your ID:', id);
                        currentUserPeerId = id;
                        localStorage.setItem('myPeerId', id);
                        if (peerIdDisplay) peerIdDisplay.textContent = id;
                        updatePeerIdInUI();

                        // AUTOMATION: Save Peer ID to Firestore
                        if (currentUser) {
                            const userDocRef = doc(db, "users", currentUser.uid);
                            updateDoc(userDocRef, { peerId: id, isOnline: true })
                                .then(() => console.log("âœ… Peer ID saved to Firestore"))
                                .catch(err => console.error("âŒ Failed to save Peer ID:", err));
                        }
                    });

                    peer.on('call', function (call) {
                        console.log('ðŸ“ž Incoming call from:', call.peer);
                        handleIncomingCall(call);
                    });

                    peer.on('error', function (error) {
                        console.error('âŒ PeerJS Error:', error.type, error.message);
                        // Use fallback ID if PeerJS fails
                        if (!currentUserPeerId) {
                            currentUserPeerId = generateFallbackPeerId();
                            localStorage.setItem('myPeerId', currentUserPeerId);
                            if (peerIdDisplay) peerIdDisplay.textContent = currentUserPeerId;
                            updatePeerIdInUI();
                            console.log('âš ï¸ Using fallback Peer ID:', currentUserPeerId);

                            // AUTOMATION: Save Fallback Peer ID to Firestore
                            if (currentUser) {
                                const userDocRef = doc(db, "users", currentUser.uid);
                                updateDoc(userDocRef, { peerId: currentUserPeerId, isOnline: true })
                                    .catch(err => console.error("âŒ Failed to save Fallback Peer ID:", err));
                            }
                        }
                    });

                    peer.on('disconnected', function () {
                        console.warn('âš ï¸ Peer disconnected from signaling server');
                    });

                    peer.on('close', function () {
                        console.warn('âš ï¸ Peer connection closed');
                        peer = null;
                    });
                }

                // Set a timeout to use fallback if PeerJS doesn't connect
                setTimeout(() => {
                    if (!currentUserPeerId) {
                        console.warn('âš ï¸ PeerJS taking too long, using fallback ID');
                        currentUserPeerId = generateFallbackPeerId();
                        localStorage.setItem('myPeerId', currentUserPeerId);
                        if (peerIdDisplay) peerIdDisplay.textContent = currentUserPeerId;
                        updatePeerIdInUI();
                    }
                }, 3000);

            } catch (error) {
                console.error('âŒ Failed to initialize PeerJS:', error);
                console.log('ðŸ’¡ Switching to fallback Peer ID generation');
                currentUserPeerId = generateFallbackPeerId();
                localStorage.setItem('myPeerId', currentUserPeerId);
                if (peerIdDisplay) peerIdDisplay.textContent = currentUserPeerId;
                updatePeerIdInUI();
                peer = null; // Clear invalid peer reference
            }
        }

        function updatePeerIdInUI() {
            // Display peer ID in multiple places
            if (currentUserPeerId && peerIdDisplay) {
                peerIdDisplay.textContent = currentUserPeerId;
                console.log('ðŸ†” Your Peer ID:', currentUserPeerId);
            }
        }

        // Diagnostic function for troubleshooting (type in console: diagnose())
        window.diagnose = function () {
            console.clear();
            console.log('%c=== CALL SYSTEM DIAGNOSTICS ===', 'color: blue; font-size: 14px; font-weight: bold;');
            console.log('Timestamp:', new Date().toISOString());
            console.log('');

            console.log('%cUSER & AUTH:', 'color: green; font-weight: bold;');
            console.log('Logged In:', !!currentUser);
            console.log('User Email:', currentUser?.email || 'NOT LOGGED IN');
            console.log('User UID:', currentUser?.uid?.substring(0, 10) + '...' || 'NONE');
            console.log('');

            console.log('%cPEER ID SYSTEM:', 'color: green; font-weight: bold;');
            console.log('Current Peer ID:', currentUserPeerId || 'NOT SET');
            console.log('Cached Peer ID (localStorage):', localStorage.getItem('myPeerId') || 'NONE');
            console.log('');

            console.log('%cPEERJS CONNECTION:', 'color: orange; font-weight: bold;');
            console.log('PeerJS Library Loaded:', typeof Peer === 'function' ? 'âœ… YES' : 'âŒ NO');
            console.log('Peer Object Exists:', !!peer ? 'âœ… YES' : 'âŒ NO');
            if (peer) {
                console.log('Peer ID:', peer.id || 'UNKNOWN');
                console.log('Peer Open:', peer.open ? 'âœ… YES' : 'âŒ NO');
                console.log('Peer Destroyed:', peer.destroyed ? 'âŒ YES (BAD)' : 'âœ… NO');
                console.log('Signaling State:', peer.peerConnection?.signalingState || 'UNKNOWN');
                console.log('Connection State:', peer.peerConnection?.connectionState || 'UNKNOWN');
                console.log('ICE Connection State:', peer.peerConnection?.iceConnectionState || 'UNKNOWN');
            } else {
                console.log('âš ï¸ Peer object not created yet');
            }
            console.log('');

            console.log('%cMEDIA STREAMS:', 'color: orange; font-weight: bold;');
            console.log('Local Stream Active:', !!localStream ? 'âœ… YES' : 'âŒ NO');
            if (localStream) {
                console.log('Audio Tracks:', localStream.getAudioTracks().length);
                console.log('Video Tracks:', localStream.getVideoTracks().length);
                localStream.getTracks().forEach((track, i) => {
                    console.log(`  Track ${i}:`, track.kind, track.enabled ? 'âœ…' : 'âŒ', track.readyState);
                });
            }
            console.log('');

            console.log('%cCALL STATE:', 'color: orange; font-weight: bold;');
            console.log('Current Call Exists:', !!currentCall ? 'âœ… YES' : 'âŒ NO');
            console.log('Call Active:', isCallActive ? 'âœ… YES' : 'âŒ NO');
            console.log('');

            console.log('%cBROWSER INFO:', 'color: purple; font-weight: bold;');
            console.log('User Agent:', navigator.userAgent);
            console.log('WebRTC Support:', typeof RTCPeerConnection !== 'undefined' ? 'âœ… YES' : 'âŒ NO');
            console.log('getUserMedia Support:', navigator.mediaDevices?.getUserMedia ? 'âœ… YES' : 'âŒ NO');
            console.log('');

            console.log('%cQUICK ACTIONS:', 'color: blue; font-weight: bold;');
            console.log('Initialize PeerJS: initializePeer()');
            console.log('Test WebRTC: navigator.mediaDevices.enumerateDevices()');
            console.log('Get Call Info: currentCall?.peerConnection?.getStats()');
            console.log('');

            console.log('%c=== END DIAGNOSTICS ===', 'color: blue; font-size: 14px; font-weight: bold;');
        };

        console.log('%câœ… Diagnostics ready! Type in console: diagnose()', 'color: green; font-weight: bold;');

        async function handleIncomingCall(call) {
            document.getElementById('incoming-caller-name').textContent = currentChatUser?.displayName || call.peer;
            document.getElementById('incoming-caller-avatar').src = currentChatUser?.photoURL || '';
            document.getElementById('incoming-call-type').textContent = 'is calling...';
            incomingCallModal.classList.remove('hidden');
            currentCall = call;

            setTimeout(() => {
                if (!incomingCallModal.classList.contains('hidden')) {
                    rejectCall();
                }
            }, 30000);
        }

        async function initiateCall(type) {
            if (!currentChatUser || !currentUser) {
                alert('Please select a user to call');
                return;
            }

            if (!peer) {
                initializePeer();
                // Give PeerJS a moment to initialize
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            // Wait for peer ID to be ready
            if (!currentUserPeerId) {
                alert('â³ Please wait... Your Peer ID is loading...\n\nTry again in a moment.');
                return;
            }

            // Safety check - make sure peer was initialized
            if (!peer && !currentUserPeerId) {
                alert('âŒ Unable to initialize call system. Please refresh and try again.');
                return;
            }

            // AUTOMATION: Fetch remote Peer ID from Firestore
            document.getElementById('loading-spinner').classList.remove('hidden');
            let remotePeerId = null;

            try {
                const userDocRef = doc(db, "users", currentChatUser.uid);
                const userSnap = await getDoc(userDocRef);

                if (userSnap.exists() && userSnap.data().peerId) {
                    remotePeerId = userSnap.data().peerId;
                    console.log("âœ… Found remote Peer ID:", remotePeerId);
                } else {
                    document.getElementById('loading-spinner').classList.add('hidden');
                    alert(`Cannot call ${currentChatUser.displayName}. They might be offline or haven't opened the app recently.`);
                    return;
                }
            } catch (error) {
                console.error("Error fetching remote peer ID:", error);
                document.getElementById('loading-spinner').classList.add('hidden');
                alert("Failed to connect. Please try again.");
                return;
            }
            document.getElementById('loading-spinner').classList.add('hidden');

            callType = type;
            document.getElementById('call-user-name').textContent = currentChatUser.displayName;
            document.getElementById('call-user-avatar').src = currentChatUser.photoURL;
            document.getElementById('call-status').textContent = 'Requesting permission...';
            callModal.classList.remove('hidden');

            try {
                const constraints = {
                    audio: true,
                    video: type === 'video' ? { width: { ideal: 640 }, height: { ideal: 480 } } : false
                };

                console.log('ðŸ”µ Requesting media:', constraints);
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                console.log('âœ… Media stream obtained');

                localVideo.srcObject = localStream;
                localVideo.muted = true; // Prevent local audio feedback
                document.getElementById('call-status').textContent = 'Calling...';

                // Safety check before calling
                // If peer is not initialized, allow calling with fallback ID only
                if (!peer || !peer.open) {
                    console.warn('âš ï¸ PeerJS not available. Attempting with fallback mode...');
                    document.getElementById('call-status').textContent = 'Connecting to network...';

                    // Wait a bit for peer to potentially connect
                    if (peer) {
                        await new Promise((resolve) => {
                            const checkInterval = setInterval(() => {
                                if (peer.open) {
                                    clearInterval(checkInterval);
                                    resolve();
                                }
                            }, 100);
                            // Timeout after 3 seconds
                            setTimeout(() => {
                                clearInterval(checkInterval);
                                resolve();
                            }, 3000);
                        });
                    } else {
                        // No peer object at all - wait a bit
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }

                // Final check - can we actually make a call?
                if (!peer || typeof peer.call !== 'function') {
                    console.warn('âš ï¸ PeerJS call not available - showing fallback message');
                    alert('âš ï¸ Peer connection is not yet established.\n\nPlease refresh the page and try again.\n\nMake sure both users have their Peer IDs visible.');
                    throw new Error('Cannot make call - PeerJS not ready');
                }

                console.log('ðŸ“ž Calling:', remotePeerId);
                console.log('ðŸ” Peer info - ID:', peer.id, 'Open:', peer.open);

                try {
                    currentCall = peer.call(remotePeerId, localStream);
                } catch (callError) {
                    console.error('âŒ peer.call() threw error:', callError);
                    throw new Error('Failed to initiate call: ' + callError.message);
                }

                if (!currentCall) {
                    console.error('âŒ peer.call() returned undefined');
                    throw new Error('Failed to create call - peer.call() returned undefined');
                }

                console.log('âœ… Call object created:', currentCall.peerConnection);

                currentCall.on('stream', function (remoteStream) {
                    console.log('âœ… Received remote stream');
                    remoteVideo.srcObject = remoteStream;
                    document.getElementById('call-status').textContent = 'Connected';
                    document.getElementById('remote-label').textContent = currentChatUser.displayName;
                    isCallActive = true;
                });

                currentCall.on('close', function () {
                    console.log('ðŸ“ž Call ended');
                    endCall();
                });

                currentCall.on('error', function (error) {
                    console.error('âŒ Call error:', error);
                    alert('Call failed: ' + error.message);
                    endCall();
                });

            } catch (error) {
                console.error('âŒ CALL ERROR:', error.name, error.message);
                callModal.classList.add('hidden');

                let msg = '';
                if (error.name === 'NotAllowedError') {
                    msg = 'Permission Denied\n\nYou blocked camera/microphone.\n\nAllow in: Browser Settings â†’ Privacy â†’ Camera/Microphone';
                } else if (error.name === 'NotFoundError') {
                    msg = 'No Device\n\nYour computer does not have a camera/microphone.';
                } else if (error.name === 'NotReadableError') {
                    msg = 'Device Busy\n\nClose other apps (Zoom, Teams, Discord).';
                } else if (error.name === 'OverconstrainedError') {
                    msg = 'Device Limitation\n\nTry audio-only call.';
                } else {
                    msg = 'Error: ' + error.message;
                }
                alert(msg);
            }
        }

        async function acceptCall() {
            if (!currentCall) {
                alert('No incoming call');
                return;
            }

            incomingCallModal.classList.add('hidden');
            document.getElementById('call-status').textContent = 'Connecting...';
            callModal.classList.remove('hidden');

            try {
                const constraints = {
                    audio: true,
                    video: callType === 'video' ? { width: { ideal: 640 }, height: { ideal: 480 } } : false
                };

                console.log('ðŸ”µ Requesting media for accept:', constraints);
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                console.log('âœ… Media stream obtained');

                localVideo.srcObject = localStream;

                currentCall.answer(localStream);

                currentCall.on('stream', function (remoteStream) {
                    console.log('âœ… Received remote stream');
                    remoteVideo.srcObject = remoteStream;
                    document.getElementById('call-status').textContent = 'Connected';
                    document.getElementById('remote-label').textContent = currentChatUser.displayName;
                    isCallActive = true;
                });

                currentCall.on('close', function () {
                    console.log('ðŸ“ž Call ended');
                    endCall();
                });

                currentCall.on('error', function (error) {
                    console.error('âŒ Call error:', error);
                    alert('Call failed: ' + error.message);
                    endCall();
                });

            } catch (error) {
                console.error('âŒ ACCEPT CALL ERROR:', error.name, error.message);
                incomingCallModal.classList.add('hidden');
                callModal.classList.add('hidden');

                let msg = '';
                if (error.name === 'NotAllowedError') {
                    msg = 'Permission Denied\n\nAllow in: Browser Settings â†’ Privacy â†’ Camera/Microphone';
                } else if (error.name === 'NotFoundError') {
                    msg = 'No Device\n\nYour computer does not have a camera/microphone.';
                } else if (error.name === 'NotReadableError') {
                    msg = 'Device Busy\n\nClose other apps using camera/mic.';
                } else if (error.name === 'OverconstrainedError') {
                    msg = 'Device Limitation\n\nTry audio-only call.';
                } else {
                    msg = 'Error: ' + error.message;
                }
                alert(msg);
            }
        }

        function rejectCall() {
            if (currentCall) {
                currentCall.close();
                currentCall = null;
            }
            incomingCallModal.classList.add('hidden');
        }

        function toggleAudio() {
            if (localStream) {
                localStream.getAudioTracks().forEach(track => {
                    track.enabled = !track.enabled;
                    isAudioEnabled = track.enabled;
                });
                toggleAudioBtn.classList.toggle('opacity-50');
            }
        }

        function toggleVideo() {
            if (localStream) {
                localStream.getVideoTracks().forEach(track => {
                    track.enabled = !track.enabled;
                    isVideoEnabled = track.enabled;
                });
                toggleVideoBtn.classList.toggle('opacity-50');
            }
        }

        async function endCall() {
            isCallActive = false;

            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }

            if (currentCall) {
                currentCall.close();
                currentCall = null;
            }

            callModal.classList.add('hidden');
            incomingCallModal.classList.add('hidden');

            localVideo.srcObject = null;
            remoteVideo.srcObject = null;
            document.getElementById('call-status').textContent = 'Calling...';
            document.getElementById('remote-label').textContent = 'Connecting...';
            toggleAudioBtn.classList.remove('opacity-50');
            toggleVideoBtn.classList.remove('opacity-50');
            isAudioEnabled = true;
            isVideoEnabled = true;
        }

        // NEW ADMIN PANEL LOGIC
        async function loadAdminUsers() {
            const userListEl = document.getElementById('admin-user-list');
            userListEl.innerHTML = '<p class="text-gray-500 text-center py-8">Loading users...</p>';
            const usersRef = collection(db, "users");
            const q = query(usersRef, orderBy("displayName"));
            const querySnapshot = await getDocs(q);
            userListEl.innerHTML = '';
            querySnapshot.forEach(doc => {
                const user = doc.data();
                const userEl = document.createElement('div');
                userEl.className = 'p-4 border-2 border-gray-200 rounded-xl flex items-center justify-between hover:bg-gray-50 transition-colors hover:border-blue-300';
                userEl.innerHTML = `
            <div class="flex items-center">
                <img src="${user.photoURL}" class="w-12 h-12 rounded-full mr-4 object-cover shadow-md">
                <div>
                    <p class="font-bold text-gray-800">${user.displayName}</p>
                    <p class="text-sm text-gray-500">${user.email}</p>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <span class="text-xs font-bold px-3 py-1 rounded-full ${user.isAdmin ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}">${user.isAdmin ? 'Admin' : 'User'}</span>
            </div>
        `;
                userListEl.appendChild(userEl);
            });
        }
        function loadAdminStickers() {
            const stickerListEl = document.getElementById('sticker-list-container');
            onSnapshot(doc(db, "siteSettings", "config"), (docSnap) => {
                const stickers = docSnap.exists() ? docSnap.data().stickers || [] : [];
                stickerListEl.innerHTML = '';
                if (stickers.length === 0) {
                    stickerListEl.innerHTML = '<p class="text-theme-secondary">No stickers added yet.</p>';
                    return;
                }
                stickers.forEach(sticker => {
                    const stickerWrapper = document.createElement('div');
                    stickerWrapper.className = 'relative group';
                    stickerWrapper.innerHTML = `
                <img src="${sticker.url}" class="w-16 h-16 object-contain">
                <button class="remove-sticker-btn absolute top-0 right-0 p-1 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity">
                    <i class="fas fa-times text-xs"></i>
                </button>
            `;
                    stickerWrapper.querySelector('.remove-sticker-btn').addEventListener('click', () => removeSticker(sticker));
                    stickerListEl.appendChild(stickerWrapper);
                });
            });
        }
        async function addSticker() {
            const input = document.getElementById('new-sticker-url');
            const url = input.value.trim();
            if (!url) return;
            const settingsDocRef = doc(db, "siteSettings", "config");
            const newSticker = { url: url, addedAt: serverTimestamp() };
            try {
                await updateDoc(settingsDocRef, { stickers: arrayUnion(newSticker) });
                input.value = '';
                alert("Sticker added successfully!");
            } catch (error) {
                console.error("Error adding sticker:", error);
                alert("Failed to add sticker.");
            }
        }
        async function removeSticker(sticker) {
            const settingsDocRef = doc(db, "siteSettings", "config");
            try {
                await updateDoc(settingsDocRef, { stickers: arrayRemove(sticker) });
                alert("Sticker removed successfully!");
            } catch (error) {
                console.error("Error removing sticker:", error);
                alert("Failed to remove sticker.");
            }
        }
        // Profile Customization
        const editProfileModalLogic = () => {
            editProfileButton.addEventListener('click', async (e) => {
                e.preventDefault();
                document.getElementById('user-menu').classList.add('hidden');
                editProfileModal.classList.remove('hidden');
                const userDocRef = doc(db, "users", currentUser.uid);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    profileAvatarPreview.src = userData.photoURL || `https://ui-avatars.com/api/?name=${userData.displayName}`;
                    displayNameInput.value = userData.displayName || '';
                }
            });
            closeEditProfileModal.addEventListener('click', () => {
                editProfileModal.classList.add('hidden');
            });
            changeAvatarBtn.addEventListener('click', () => {
                avatarInput.click();
            });
            avatarInput.addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        profileAvatarPreview.src = e.target.result;
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
            saveProfileBtn.addEventListener('click', async () => {
                loadingSpinner.classList.remove('hidden');
                const newDisplayName = displayNameInput.value.trim();
                let newPhotoURL = profileAvatarPreview.src;
                if (avatarInput.files[0]) {
                    const formData = new FormData();
                    formData.append('file', avatarInput.files[0]);
                    formData.append('upload_preset', cloudinaryConfig.upload_preset);
                    try {
                        const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloud_name}/image/upload`, {
                            method: 'POST',
                            body: formData,
                        });
                        const data = await response.json();
                        newPhotoURL = data.secure_url;
                    } catch (error) {
                        console.error("Error uploading profile picture:", error);
                        alert("Failed to update profile picture. Please try again.");
                        loadingSpinner.classList.add('hidden');
                        return;
                    }
                }
                try {
                    await updateUserData(currentUser.uid, {
                        displayName: newDisplayName,
                        photoURL: newPhotoURL
                    });
                    alert("Profile updated successfully!");
                } catch (error) {
                    console.error("Error updating user data:", error);
                    alert("Failed to update profile. Please try again.");
                } finally {
                    loadingSpinner.classList.add('hidden');
                    editProfileModal.classList.add('hidden');
                }
            });
        };
        const messageReplyLogic = () => {
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.addEventListener('click', (e) => {
                const messageWrapper = e.target.closest('.message-bubble-sent, .message-bubble-received');
                if (messageWrapper) {
                    const messageEl = messageWrapper.closest('[data-id]');
                    if (messageEl) {
                        replyToMessageId = messageEl.dataset.id;
                        const messageContentEl = messageWrapper.querySelector('.message-content');
                        replyText.textContent = messageContentEl.textContent || 'File/Media';
                        replyBar.classList.remove('hidden');
                        messageInput.focus();
                    }
                }
            });
            cancelReplyBtn.addEventListener('click', () => {
                replyToMessageId = null;
                replyBar.classList.add('hidden');
            });
            sendBtn.addEventListener('click', () => {
                const input = document.getElementById('message-input');
                if (input.value.trim()) {
                    sendMessage('text', input.value.trim(), null, replyToMessageId);
                    input.value = '';
                    replyToMessageId = null;
                    replyBar.classList.add('hidden');
                }
            });
        };
        const themeToggleLogic = () => {
            const htmlEl = document.documentElement;
            const themeToggleBtn = document.getElementById('theme-toggle-button');
            const iconEl = themeToggleBtn.querySelector('i');
            const textEl = themeToggleBtn.querySelector('span');
            const setTheme = (theme) => {
                if (theme === 'dark') {
                    htmlEl.classList.add('dark');
                    iconEl.className = 'fas fa-moon mr-2';
                    textEl.textContent = 'Switch to Light Mode';
                    localStorage.setItem('theme', 'dark');
                } else {
                    htmlEl.classList.remove('dark');
                    iconEl.className = 'fas fa-sun mr-2';
                    textEl.textContent = 'Switch to Dark Mode';
                    localStorage.setItem('theme', 'light');
                }
            };
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                setTheme(savedTheme);
            } else {
                setTheme('light');
            }
            themeToggleBtn.addEventListener('click', (e) => {
                e.preventDefault();
                const currentTheme = htmlEl.classList.contains('dark') ? 'light' : 'dark';
                setTheme(currentTheme);
            });
        };
        const fullscreenImageLogic = () => {
            chatHeaderAvatar.addEventListener('click', () => {
                fullscreenImage.src = chatHeaderAvatar.src;
                fullscreenImageModal.classList.remove('hidden');
            });
        }
        const adminPanelLogic = () => {
            adminPanelButton.addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('user-menu').classList.add('hidden');
                adminPanel.classList.remove('hidden');
                document.getElementById('admin-tab-users').classList.remove('hidden');
                document.getElementById('admin-tab-content').classList.add('hidden');
                document.getElementById('admin-tab-registrations').classList.add('hidden');
            });
            closeAdminPanel.addEventListener('click', () => {
                adminPanel.classList.add('hidden');
            });
            const tabLinks = document.querySelectorAll('.admin-tab-link');
            const tabContents = document.querySelectorAll('.admin-tab-content');
            tabLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    tabLinks.forEach(l => {
                        l.classList.remove('bg-theme-tertiary', 'text-theme-primary', 'font-semibold');
                        l.classList.add('text-theme-secondary', 'hover:bg-theme-tertiary', 'hover:text-theme-primary');
                    });
                    e.currentTarget.classList.add('bg-theme-tertiary', 'text-theme-primary', 'font-semibold');
                    e.currentTarget.classList.remove('text-theme-secondary', 'hover:bg-theme-tertiary', 'hover:text-theme-primary');
                    tabContents.forEach(content => content.classList.add('hidden'));
                    const targetTabId = e.currentTarget.getAttribute('href').substring(1);
                    document.getElementById(`admin-tab-${targetTabId}`).classList.remove('hidden');
                    if (targetTabId === 'users') {
                        loadAdminUsers();
                    } else if (targetTabId === 'content') {
                        loadAdminStickers();
                    }
                });
            });
            document.getElementById('add-sticker-btn').addEventListener('click', addSticker);
        };
        const voiceRecordingLogic = () => {
            recordVoiceBtn.addEventListener('click', async () => {
                if (isRecording) {
                    mediaRecorder.stop();
                    recordVoiceBtn.innerHTML = `<i class="fas fa-microphone w-4 mr-3"></i>Record Voice`;
                    recordingStatus.classList.add('hidden');
                    isRecording = false;
                } else {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        mediaRecorder = new MediaRecorder(stream);
                        audioChunks = [];
                        mediaRecorder.ondataavailable = event => {
                            audioChunks.push(event.data);
                        };
                        mediaRecorder.onstop = () => {
                            const audioBlob = new Blob(audioChunks, { 'type': 'audio/webm; codecs=opus' });
                            uploadAudio(audioBlob);
                            stream.getTracks().forEach(track => track.stop());
                        };
                        mediaRecorder.start();
                        recordVoiceBtn.innerHTML = `<i class="fas fa-stop-circle w-4 mr-3"></i>Stop Recording`;
                        recordingStatus.classList.remove('hidden');
                        isRecording = true;
                    } catch (err) {
                        console.error("Microphone access denied or failed:", err);
                        alert("Could not access microphone. Please allow microphone permissions.");
                    }
                }
            });
        };
        function searchGifs(query) {
            if (!GIPHY_API_KEY) {
                alert("Giphy API Key is missing. Please add it to your script.");
                return;
            }
            const url = query.trim() === '' ?
                `https://api.giphy.com/v1/gifs/trending?api_key=${GIPHY_API_KEY}&limit=25` :
                `https://api.giphy.com/v1/gifs/search?api_key=${GIPHY_API_KEY}&q=${encodeURIComponent(query)}&limit=25`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    giphyGrid.innerHTML = '';
                    if (data.data.length === 0) {
                        giphyGrid.innerHTML = '<p class="text-theme-secondary text-center mt-4">No GIFs found.</p>';
                    }
                    data.data.forEach(gif => {
                        const img = document.createElement('img');
                        img.src = gif.images.fixed_height.url;
                        img.alt = gif.title;
                        img.addEventListener('click', () => {
                            sendMessage('gif', 'GIF', gif.images.original.url);
                            giphyModal.style.display = 'none';
                            giphySearchInput.value = '';
                        });
                        giphyGrid.appendChild(img);
                    });
                })
                .catch(error => {
                    console.error("Error fetching GIFs:", error);
                    giphyGrid.innerHTML = '<p class="text-red-500 text-center mt-4">Failed to load GIFs.</p>';
                });
        }
        function handleGiphySearch() {
            if (gifSearchTimeout) {
                clearTimeout(gifSearchTimeout);
            }
            gifSearchTimeout = setTimeout(() => {
                searchGifs(giphySearchInput.value);
            }, 500);
        }
        async function updateSessionToken(uid) {
            const sessionToken = Math.random().toString(36).substring(2);
            const sessionRef = ref(rtdb, `activeSessions/${uid}`);
            await set(sessionRef, sessionToken);
            localStorage.setItem('sessionToken', sessionToken);
            return sessionToken;
        }
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                setChatState('currentUser', user);
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);
                const sessionRef = ref(rtdb, `activeSessions/${user.uid}`);
                onValue(sessionRef, async (snapshot) => {
                    const dbToken = snapshot.val();
                    const localToken = localStorage.getItem('sessionToken');
                    if (localToken && dbToken && dbToken !== localToken) {
                        console.log("Logged out from another device.");
                        alert("Your account has been logged in from another device. You will be logged out here.");
                        await signOut(auth);
                        return;
                    }
                });
                if (!localStorage.getItem('sessionToken')) {
                    await updateSessionToken(user.uid);
                }
                if (userDocSnap.exists()) {
                    setChatState('isAdmin', userDocSnap.data().isAdmin || false);
                } else {
                    const newUserIsAdmin = user.email === ADMIN_EMAIL;
                    await setDoc(userDocRef, {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.email.split('@')[0],
                        photoURL: `https://ui-avatars.com/api/?name=${user.email.split('@')[0]}&background=random`,
                        isAdmin: newUserIsAdmin
                    });
                    setChatState('isAdmin', newUserIsAdmin);
                }
                setupPresence();
                listenToSiteSettings();
                loadUI();
                editProfileModalLogic();
                messageReplyLogic();
                themeToggleLogic();
                fullscreenImageLogic();
                adminPanelLogic();
                voiceRecordingLogic();
            } else {
                setChatState('currentUser', null);
                setChatState('isAdmin', false);
                localStorage.removeItem('sessionToken');
                showAuthScreen();
            }
        });
        function loadUI() {
            if (!currentUser) return;
            const userDocRef = doc(db, "users", currentUser.uid);
            onSnapshot(userDocRef, (doc) => {
                if (doc.exists()) {
                    const userData = doc.data();
                    document.getElementById('user-avatar').src = userData.photoURL || `https://ui-avatars.com/api/?name=${userData.email.split('@')[0]}`;
                }
            });
            if (isAdmin) { document.getElementById('admin-panel-button').classList.remove('hidden'); }
            loadUserList();
            showMainApp();
            initEmojiStickerPicker();
            initializePeer(); // Initialize PeerJS for calling
            chatListContainer.classList.remove('hidden');
        }
        authToggleLink.addEventListener('click', (e) => {
            e.preventDefault();
            isLogin = !isLogin;
            document.getElementById('auth-title').textContent = isLogin ? 'Login' : 'Sign Up';
            document.getElementById('auth-button').textContent = isLogin ? 'Login' : 'Sign Up';
            authToggleText.textContent = isLogin ? "Don't have an account?" : "Already have an account?";
            authToggleLink.textContent = isLogin ? 'Sign Up' : 'Login';
            authError.classList.add('hidden');
        });
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loadingSpinner.classList.remove('hidden');
            authError.classList.add('hidden');
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                if (isLogin) {
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    await updateSessionToken(userCredential.user.uid);
                } else {
                    const settingsDocSnap = await getDoc(doc(db, "siteSettings", "config"));
                    const registrationsEnabled = settingsDocSnap.exists() ? settingsDocSnap.data().registrationsEnabled : true;
                    if (!registrationsEnabled) {
                        authError.textContent = "Sorry, new registrations are disabled by the admin.";
                        authError.classList.remove('hidden');
                        return;
                    }
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await updateSessionToken(userCredential.user.uid);
                }
            } catch (error) {
                console.error("Firebase Auth Error:", error.code, error.message);
                let errorMessage = "Authentication Error: Please try again.";
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-email') {
                    errorMessage = "Authentication Error: Invalid email or password.";
                } else if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "Authentication Error: This email is already registered.";
                }
                authError.textContent = errorMessage;
                authError.classList.remove('hidden');
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        });
        document.getElementById('logout-button').addEventListener('click', () => {
            const sessionRef = ref(rtdb, `activeSessions/${currentUser.uid}`);
            remove(sessionRef);
            signOut(auth);
        });
        document.getElementById('user-avatar').addEventListener('click', () => {
            document.getElementById('user-menu').classList.toggle('hidden');
        });
        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendBtn.click();
            }
        });
        document.getElementById('attach-file-btn').addEventListener('click', () => document.getElementById('file-input').click());
        document.getElementById('file-input').addEventListener('change', (e) => {
            if (e.target.files[0]) uploadFile(e.target.files[0]);
        });
        document.getElementById('delete-chat-btn').addEventListener('click', async () => {
            if (!currentChatId || !currentChatUser) return;
            const confirmation = confirm(`Are you sure you want to delete all messages with ${currentChatUser.displayName}? This action cannot be undone.`);
            if (confirmation) {
                loadingSpinner.classList.remove('hidden');
                try {
                    const messagesRef = collection(db, 'chats', currentChatId, 'messages');
                    const querySnapshot = await getDocs(messagesRef);
                    const batch = writeBatch(db);
                    querySnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    document.getElementById('messages-container').innerHTML = '';
                    alert('Chat history deleted successfully.');
                } catch (error) {
                    console.error("Error deleting chat:", error);
                    alert("Failed to delete chat history.");
                } finally {
                    loadingSpinner.classList.add('hidden');
                }
            }
        });
        document.getElementById('emoji-sticker-btn').addEventListener('click', () => {
            document.getElementById('emoji-sticker-picker').classList.toggle('hidden');
        });
        document.getElementById('more-options-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            document.getElementById('more-options-menu').classList.toggle('hidden');
        });
        document.addEventListener('click', (e) => {
            const moreOptionsMenu = document.getElementById('more-options-menu');
            if (!moreOptionsMenu.classList.contains('hidden') && !moreOptionsMenu.contains(e.target) && !document.getElementById('more-options-btn').contains(e.target)) {
                moreOptionsMenu.classList.add('hidden');
            }
        });
        document.getElementById('chat-with-admin-btn').addEventListener('click', async () => {
            const q = query(collection(db, "users"));
            const snapshot = await getDocs(q);
            let adminUser = null;
            snapshot.forEach(doc => {
                const user = doc.data();
                if (user.isAdmin && user.uid !== currentUser.uid) {
                    adminUser = user;
                }
            });
            if (adminUser) {
                startChat(adminUser);
            } else {
                alert("No available admins to chat with at the moment.");
            }
        });
        backToChatsBtn.addEventListener('click', () => {
            chatListContainer.classList.remove('hidden');
            chatWindowWrapper.classList.add('hidden');
            document.getElementById('chat-window').classList.add('hidden');
            welcomeScreen.classList.remove('hidden');
        });
        voiceCallBtn.addEventListener('click', () => {
            initiateCall('audio');
        });
        videoCallBtn.addEventListener('click', () => {
            initiateCall('video');
        });
        closeCallModal.addEventListener('click', () => {
            endCall();
        });
        endCallBtn.addEventListener('click', () => {
            endCall();
        });
        acceptCallBtn.addEventListener('click', () => {
            acceptCall();
        });
        rejectCallBtn.addEventListener('click', () => {
            rejectCall();
        });
        toggleAudioBtn.addEventListener('click', () => {
            toggleAudio();
        });
        toggleVideoBtn.addEventListener('click', () => {
            toggleVideo();
        });
        // Peer ID Modal Event Listeners
        showPeerIdBtn.addEventListener('click', (e) => {
            e.preventDefault();
            // Always show current ID (fallback or real)
            if (currentUserPeerId) {
                peerIdDisplay.textContent = currentUserPeerId;
                peerIdDisplay.style.color = '#1e40af'; // Blue color
            } else {
                peerIdDisplay.textContent = 'Initializing...';
                peerIdDisplay.style.color = '#f59e0b'; // Amber color for loading
            }
            peerIdModal.classList.remove('hidden');
            document.getElementById('user-menu').classList.add('hidden');
        });
        closePeerIdModal.addEventListener('click', () => {
            peerIdModal.classList.add('hidden');
        });
        closePeerIdBtn.addEventListener('click', () => {
            peerIdModal.classList.add('hidden');
        });
        copyPeerIdBtn.addEventListener('click', () => {
            if (currentUserPeerId) {
                navigator.clipboard.writeText(currentUserPeerId).then(() => {
                    const btnText = document.getElementById('copy-btn-text');
                    const originalHTML = copyPeerIdBtn.innerHTML;
                    btnText.textContent = 'âœ… Copied!';
                    copyPeerIdBtn.style.background = 'linear-gradient(to right, #10b981, #059669)';
                    setTimeout(() => {
                        btnText.textContent = 'Copy to Clipboard';
                        copyPeerIdBtn.style.background = 'linear-gradient(to right, #3b82f6, #2563eb)';
                    }, 2000);
                }).catch(() => {
                    alert('Failed to copy. Try copying manually: ' + currentUserPeerId);
                });
            } else {
                alert('â³ Peer ID is still initializing. Please wait a moment and try again.');
            }
        });
        // retryPermissionBtn removed - using simple alerts instead
        // if (retryPermissionBtn) {
        //     retryPermissionBtn.addEventListener('click', () => {
        //         hidePermissionError();
        //         if (pendingCallType) {
        //             console.log('Retrying call with type:', pendingCallType);
        //             initiateCall(pendingCallType);
        //         }
        //     });
        // }
        giphyBtn.addEventListener('click', () => {
            giphyModal.style.display = 'flex';
            searchGifs('');
        });
        closeGiphyModal.addEventListener('click', () => {
            giphyModal.style.display = 'none';
            giphySearchInput.value = '';
            giphyGrid.innerHTML = '';
        });
        giphySearchInput.addEventListener('input', handleGiphySearch);
    </script>
</body>

</html>
